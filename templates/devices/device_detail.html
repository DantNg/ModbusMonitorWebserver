{% extends "base.html" %}
{% set page_title = "Device • " + device.name %}
{% block content %}
<div class="row g-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <div class="h5 mb-1">{{ device.name }}</div>
            <div class="text-muted small">{{ device.description or "—" }}</div>
          </div>
          <span class="badge text-bg-secondary">{{ device.protocol }}</span>
        </div>

        <div class="row g-3">
          <div class="col-6 col-md-2">
            <div class="border rounded p-2">
              <div class="small text-muted">Host</div>
              <div class="fw-semibold">{{ device.host }}</div>
            </div>
          </div>
          <div class="col-6 col-md-2">
            <div class="border rounded p-2">
              <div class="small text-muted">Port</div>
              <div class="fw-semibold">{{ device.port }}</div>
            </div>
          </div>
          <div class="col-6 col-md-2">
            <div class="border rounded p-2">
              <div class="small text-muted">Unit ID</div>
              <div class="fw-semibold">{{ device.unit_id }}</div>
            </div>
          </div>
          <div class="col-6 col-md-2">
            <div class="border rounded p-2">
              <div class="small text-muted">Timeout (ms)</div>
              <div class="fw-semibold">{{ device.timeout_ms }}</div>
            </div>
          </div>
          <div class="col-6 col-md-2">
            <div class="border rounded p-2">
              <div class="small text-muted">Byte Order</div>
              <div class="fw-semibold">{{ device.byte_order }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 d-flex align-items-center">
    <h6 class="mb-0 me-auto text-uppercase text-muted">Tags</h6>
    <a class="btn btn-primary" href="{{ url_for('devices_bp.add_tag', did=device.id) }}">+ Add Tag</a>
  </div>

  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-dark-subtle">
            <tr>
              <th>Name</th>
              <th>Address</th>
              <th>Datatype</th>
              <th>Unit</th>
              <th>Scale</th>
              <th>Offset</th>
              <th>Description</th>
              <th>Write Value</th>
              <th class="text-end" style="width:160px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tags %}
            <tr>
              <td class="fw-semibold">{{ t.name }}</td>
              <td>{{ t.address }}</td>
              <td><span class="badge text-bg-secondary">{{ t.datatype }}</span></td>
              <td>{{ t.unit or "" }}</td>
              <td>{{ t.scale }}</td>
              <td>{{ t.offset }}</td>
              <td class="text-muted">{{ t.description or "—" }}</td>
              <td>
                <div class="input-group input-group-sm" style="width: 150px;">
                  <input type="number" step="any" class="form-control" id="writeValue{{t.id}}" placeholder="Value">
                  <button class="btn btn-outline-success" type="button" onclick="writeTag({{ t.id }}, '{{ t.name }}')">
                    <i class="bi bi-arrow-down-circle"></i> Write
                  </button>
                </div>
              </td>
              <td class="text-end">
                <div class="btn-group">
                  <a class="btn btn-sm btn-outline-secondary"
                    href="{{ url_for('devices_bp.edit_tag', did=device.id, tid=t.id) }}">Edit</a>
                  <form method="post" action="{{ url_for('devices_bp.delete_tag', did=device.id, tid=t.id) }}"
                    onsubmit="return confirm('Delete this tag?')">
                    <button class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">No tags yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>


</div>

<script>
function writeTag(tagId, tagName) {
  const valueInput = document.getElementById(`writeValue${tagId}`);
  const value = valueInput.value;
  
  if (value === '') {
    alert('Please enter a value to write');
    return;
  }
  
  // Disable button during write
  const button = event.target;
  const originalText = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
  
  fetch(`/api/tags/${tagId}/write`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      value: parseFloat(value)
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`Successfully wrote ${value} to ${tagName}`);
      valueInput.value = ''; // Clear the input
    } else {
      alert(`Failed to write to ${tagName}: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert(`Error writing to ${tagName}: ${error.message}`);
  })
  .finally(() => {
    // Re-enable button
    button.disabled = false;
    button.innerHTML = originalText;
  });
}
</script>
{% endblock %}