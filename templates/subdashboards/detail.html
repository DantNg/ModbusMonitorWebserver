{% extends "base.html" %}
{% set page_title = "Sub Dashboard: " ~ subdash.name %}
{% block content %}

<div class="card border-0 shadow-soft mb-3">
  <div class="card-body d-flex flex-wrap gap-3 align-items-center">
    <div>
      <div class="text-muted small">Group</div>
      <select id="sel-group" class="form-select form-select-sm" onchange="App.changeGroup(this.value)">
        <option value="__all__" {{ 'selected' if current_group=='__all__' else '' }}>All Groups</option>
        {% for group in groups %}
        <option value="{{ group.id }}" {{ 'selected' if current_group==group.id|string else '' }}>
          {{ group.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <a href="{{ url_for('subdash_bp.list_subdash') }}" class="btn btn-sm btn-outline-secondary">‚Üê Back</a>
      <button id="testSocketBtn" class="btn btn-sm btn-info">üîå Test Socket</button>
      <button id="forceRefreshBtn" class="btn btn-sm btn-warning">üîÑ Force Refresh</button>
      <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addTagModal">+ Add Tag</button>
      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addGroupModal">+ Add Tag Group</button>
      <div class="small text-muted">Auto refresh: 1s</div>
    </div>
  </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="alert-container mb-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else 'warning' if category == 'warning' else 'success' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div id="group-panels">
  {% if current_group == '__all__' %}
  {% for group in groups %}
  <div class="card border-0 shadow-soft mb-4">
    <div class="card-header bg-info text-white rounded-top fw-bold d-flex justify-content-between align-items-center">
      <span>{{ group.name }}</span>
      <form method="post" action="{{ url_for('subdash_bp.delete_group', sid=subdash.id, gid=group.id) }}" 
            class="d-inline" onsubmit="return confirm('Are you sure you want to delete the group \'{{ group.name }}\'?')">
        <button type="submit" class="btn btn-sm btn-outline-light" title="Delete Group">
          <i class="bi bi-trash"></i>
        </button>
      </form>
    </div>
    <div class="card-body">
      <div class="row g-4">
        {% for tag in group.tags %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card border-0 shadow-soft tile">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-semibold">{{ tag.name }}</div>
                  <div class="text-muted small">{{ tag.description or ' ' }}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-secondary">{{ tag.datatype }}</span>
                  {% if tag.function_code != 2 and tag.function_code != 4 %}
                  <button class="btn btn-sm btn-outline-primary write-btn" 
                          data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}"
                          title="Write Value">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  {% endif %}
                </div>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <div>
                  {% if tag.alarm_status == "Normal" %}
                  <span class="badge bg-success">Normal</span>
                  {% else %}
                  <span class="badge bg-danger">Alarm</span>
                  {% endif %}
                </div>
                <div class="small text-muted">
                  <i class="bi bi-clock"></i> {{ tag.ts }}
                </div>
              </div>
              <div class="value-row d-flex align-items-center justify-content-center flex-column">
                <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
                  {{ tag.value if tag.value is not none else '‚Äî' }}
                </div>
                <div class="unit">Unit {{ tag.unit }}</div>
              </div>
              <div class="meter mt-2">
                <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:0%"></div>
              </div>
              <div class="text-end small text-muted mt-1" id="tag-ts-{{ tag.id }}"></div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  {% for group in groups %}
  {% if current_group == group.id|string %}
  <div class="card border-0 shadow-soft mb-4">
    <div class="card-header bg-info text-white rounded-top fw-bold d-flex justify-content-between align-items-center">
      <span>{{ group.name }}</span>
      <form method="post" action="{{ url_for('subdash_bp.delete_group', sid=subdash.id, gid=group.id) }}" 
            class="d-inline" onsubmit="return confirm('Are you sure you want to delete the group \'{{ group.name }}\'?')">
        <button type="submit" class="btn btn-sm btn-outline-light" title="Delete Group">
          <i class="bi bi-trash"></i>
        </button>
      </form>
    </div>
    <div class="card-body">
      <div class="row g-4">
        {% for tag in group.tags %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card border-0 shadow-soft tile">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-semibold">{{ tag.name }}</div>
                  <div class="text-muted small">{{ tag.description or ' ' }}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-secondary">{{ tag.datatype }}</span>
                  {% if tag.function_code != 2 and tag.function_code != 4 %}
                  <button class="btn btn-sm btn-outline-primary write-btn" 
                          data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}"
                          title="Write Value">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  {% endif %}
                </div>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <div>
                  {% if tag.alarm_status == "Normal" %}
                  <span class="badge bg-success">Normal</span>
                  {% else %}
                  <span class="badge bg-danger">Alarm</span>
                  {% endif %}
                </div>
                <div class="small text-muted">
                  <i class="bi bi-clock"></i> {{ tag.ts }}
                </div>
              </div>
              <div class="value-row d-flex align-items-center justify-content-center flex-column">
                <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
                  {{ tag.value if tag.value is not none else '‚Äî' }}
                </div>
                <div class="unit">Unit {{ tag.unit }}</div>
              </div>
              <div class="meter mt-2">
                <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:0%"></div>
              </div>
              <div class="text-end small text-muted mt-1" id="tag-ts-{{ tag.id }}"></div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}
  {% endif %}
</div>


<!-- Modal: Add Tag -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTagModalLabel">Add Tag to {{ subdash.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('subdash_bp.add_tag_to_subdash', sid=subdash.id) }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="tag_id" class="form-label">Select Tag</label>
            <select id="tag_id" name="tag_id" class="form-select" required>
              <option value="">Choose a tag...</option>
              {% for tag in all_tags %}
              <option value="{{ tag.id }}">{{ tag.tag_name }} ({{ tag.device_name }})</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="target_group" class="form-label">Add to Group</label>
            <div class="input-group">
              <select id="target_group" name="target_group" class="form-select">
                <option value="">Select existing group...</option>
                {% for group in groups %}
                <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-outline-secondary" type="button" id="toggleNewGroup" onclick="toggleNewGroupInput()">
                <i class="bi bi-plus-circle"></i> New
              </button>
            </div>
            <small class="text-muted">Select an existing group or create a new one</small>
          </div>
          
          <!-- New Group Input (hidden by default) -->
          <div class="mb-3" id="newGroupSection" style="display: none;">
            <label for="new_group_name" class="form-label">New Group Name</label>
            <input type="text" id="new_group_name" name="new_group_name" class="form-control" placeholder="Enter group name...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Tag</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Add Tag Group -->
<div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addGroupModalLabel">Add Tag Group to {{ subdash.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('subdash_bp.add_group_to_subdash', sid=subdash.id) }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="group_name" class="form-label">Group Name</label>
            <input type="text" id="group_name" name="group_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="group_tags" class="form-label">Select Tags for Group</label>
            <select id="group_tags" name="group_tags" class="form-select" multiple required>
              {% for tag in all_tags %}
              <option value="{{ tag.id }}">{{ tag.tag_name }} ({{ tag.device_name }})</option>
              {% endfor %}
            </select>
            <small class="text-muted">Hold Ctrl/Command to select multiple tags.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Group</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
  // Wrap everything in DOMContentLoaded to ensure buttons exist
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Subdashboard DOM loaded, initializing...');
    
    // App globals for subdashboard
    window.App = window.App || {};
    
    const currentSubdashId = "{{ subdash.id }}";
    const currentGroup = "{{ current_group }}";
    
    // Test functions
    function testSocketConnection() {
      console.log('=== SOCKET CONNECTION TEST ===');
      console.log('Socket connected:', typeof socket !== 'undefined' ? socket.connected : 'socket not defined');
      console.log('Socket ID:', typeof socket !== 'undefined' ? socket.id : 'socket not defined');
      console.log('Current subdash ID:', currentSubdashId);
      console.log('Expected room:', `subdashboard_${currentSubdashId}`);
      
      if (typeof socket !== 'undefined') {
        // Try to rejoin room
        socket.emit('join', { room: `subdashboard_${currentSubdashId}` });
        console.log('Re-joined room');
      }
      
      // Test API endpoint
      fetch(`/subdashboards/debug/${currentSubdashId}`)
        .then(r => r.json())
        .then(data => {
          console.log('Debug data:', data);
          alert(`Subdash has ${data.tag_count} tags in ${data.group_count} groups`);
        })
        .catch(e => console.error('Debug API error:', e));
    }

    function forceRefresh() {
      console.log('Force refreshing tags...');
      if (App.refreshTags) {
        App.refreshTags();
      } else {
        console.log('App.refreshTags not available, reloading page');
        location.reload();
      }
    }
    
    // Setup button event listeners
    const testBtn = document.getElementById('testSocketBtn');
    const refreshBtn = document.getElementById('forceRefreshBtn');
    
    console.log('Test button found:', testBtn);
    console.log('Refresh button found:', refreshBtn);
    
    if (testBtn) {
      testBtn.addEventListener('click', function() {
        console.log('Test button clicked');
        testSocketConnection();
      });
      console.log('Test button event listener added');
    }
    
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function() {
        console.log('Refresh button clicked');
        forceRefresh();
      });
      console.log('Refresh button event listener added');
    }

    // Expose functions globally for console access
    window.testSocketConnection = testSocketConnection;
    window.forceRefresh = forceRefresh;

    // Change group function
    App.changeGroup = function(groupId) {
      // Leave current room before navigating
      if (typeof socket !== 'undefined') {
        socket.emit('leave', { room: `subdashboard_${currentSubdashId}` });
        console.log(`Left subdashboard room: subdashboard_${currentSubdashId}`);
      }
      
      // Navigate to new group
      const url = new URL(window.location);
      url.searchParams.set('group', groupId);
      window.location.href = url.toString();
    };

    // Initialize App for subdashboard
    App.startDashboard('/api/tags?subdash={{ subdash.id }}');
    
    // Backup polling mechanism if Socket.IO fails
    let socketConnected = false;
    let pollingInterval = null;
    
    // Check if we're receiving socket updates
    setTimeout(function() {
      if (!socketConnected) {
        console.warn('Socket.IO not receiving updates, falling back to polling');
        // Start polling every 2 seconds as fallback
        pollingInterval = setInterval(function() {
          App.refreshTags();
        }, 2000);
      }
    }, 5000); // Wait 5 seconds for socket updates

    // Socket connection for subdashboard
    const socket = io();
    console.log('Socket.IO initialized for subdashboard');
    
    // Join appropriate room based on current subdashboard
    if (window.location.pathname.startsWith('/subdashboards/')) {
      const roomName = `subdashboard_${currentSubdashId}`;
      socket.emit('join', { room: roomName });
      console.log(`Joined subdashboard room: ${roomName}`);
      
      // Verify connection
      socket.on('connect', function() {
        console.log('‚úÖ Socket connected successfully, re-joining room:', roomName);
        socket.emit('join', { room: roomName });
        socketConnected = true;
      });
      
      socket.on('disconnect', function() {
        console.log('‚ùå Socket disconnected');
        socketConnected = false;
      });

      socket.on('connect_error', function(error) {
        console.error('‚ùå Socket connection error:', error);
      });

      // Test if we can receive any socket events
      socket.on('joined_room', function(data) {
        console.log('‚úÖ Successfully joined room:', data);
      });
    }
    
    // Leave room when page unloads
    window.addEventListener('beforeunload', function() {
      if (socket) {
        socket.emit('leave', { room: `subdashboard_${currentSubdashId}` });
        console.log(`Left subdashboard room: subdashboard_${currentSubdashId}`);
      }
    });

  const tagUpdateTimers = {};
  
  // Listen for real-time modbus updates (new high-speed format)
  socket.on("modbus_update", function (data) {
    console.log('Received high-speed modbus update for subdash:', data);
    socketConnected = true; // Mark socket as working
    
    // Clear polling fallback if socket is working
    if (pollingInterval) {
      clearInterval(pollingInterval);
      pollingInterval = null;
      console.log('Socket.IO working, stopped polling fallback');
    }
    
    if (!data || !data.tags) return;
    
    // Show device activity in console for debugging
    console.log(`[${new Date().toLocaleTimeString()}] Subdash Device ${data.device_name || data.device_id}: ${data.tag_count} tags, ${data.latency_ms}ms latency, seq: ${data.seq}`);

    data.tags.forEach(tag => {
      const valEl = document.getElementById('tag-val-' + tag.id);
      if (!valEl) {
        // Tag not visible in current group filter, skip update
        console.log(`Tag ${tag.id} not found in DOM, skipping`);
        return;
      }

      const oldVal = valEl.textContent;
      const newVal = tag.value !== null ? Number(tag.value).toFixed(2) : '‚Äî';

      // Update text
      valEl.textContent = newVal;
      const tsEl = document.getElementById('tag-ts-' + tag.id);
      if (tsEl) tsEl.textContent = tag.ts || '';

      // Always show activity bar for real-time updates (green = fresh data)
      const actEl = document.getElementById('tag-activity-' + tag.id);
      if (actEl) {
        // Clear previous timer
        if (tagUpdateTimers[tag.id]) {
          clearTimeout(tagUpdateTimers[tag.id]);
        }

        actEl.style.backgroundColor = '#28a745'; // Green for real-time
        actEl.style.opacity = '0.8';
        
        // Fade out activity indicator after 1 second
        tagUpdateTimers[tag.id] = setTimeout(() => {
          actEl.style.opacity = '0.1';
        }, 1000);
      }

      // Highlight changes in subdashboard
      if (oldVal !== newVal && oldVal !== '‚Äî') {
        if (valEl.parentElement) {
          valEl.parentElement.style.backgroundColor = '#e8f5e8';
          setTimeout(() => {
            if (valEl.parentElement) {
              valEl.parentElement.style.backgroundColor = '';
            }
          }, 2000);
        }
      }

      // Progress bar animation for real-time updates
      const barEl = document.getElementById('tag-bar-' + tag.id);
      if (barEl) {
        barEl.style.width = "100%";
        barEl.style.backgroundColor = "#28a745"; // Green color
        console.log(`Real-time update bar for tag ${tag.id}: 100% (activity indicator)`);

        if (tagUpdateTimers[tag.id]) clearTimeout(tagUpdateTimers[tag.id]);
        tagUpdateTimers[tag.id] = setTimeout(() => {
          barEl.style.backgroundColor = "";
          barEl.style.width = "0%"; // Reset after 20 seconds
        }, 20000);
      }

      // Add visual feedback for value changes
      valEl.style.transition = 'background-color 0.3s';
      valEl.style.backgroundColor = '#28a745';
      setTimeout(() => {
        valEl.style.backgroundColor = '';
      }, 300);
      console.log(`Real-time updated tag ${tag.id} from ${oldVal} to ${newVal}`);
    });
  });

  // Keep legacy listener for backward compatibility
  socket.on("update_tags", function (data) {
    console.log('Received legacy tag updates:', data);
    if (!data || !data.tags) return;

    data.tags.forEach(tag => {
      const valEl = document.getElementById('tag-val-' + tag.id);
      if (!valEl) return;

      const oldVal = valEl.textContent;
      const newVal = tag.value !== null ? Number(tag.value).toFixed(2) : '‚Äî';

      // Update text
      valEl.textContent = newVal;
      const tsEl = document.getElementById('tag-ts-' + tag.id);
      if (tsEl) tsEl.textContent = tag.ts || '';

      // Update meter bar to show activity (like dashboard)
      if (oldVal !== newVal) {
        const barEl = document.getElementById('tag-bar-' + tag.id);
        if (barEl) {
          barEl.style.width = "100%";
          barEl.style.backgroundColor = "#28a745"; // Green color
          console.log(`Updated bar for tag ${tag.id}: 100% (activity indicator)`);

          if (tagUpdateTimers[tag.id]) clearTimeout(tagUpdateTimers[tag.id]);
          tagUpdateTimers[tag.id] = setTimeout(() => {
            barEl.style.backgroundColor = "";
            barEl.style.width = "0%"; // Reset after 20 seconds
          }, 20000);
        }

        // Add visual feedback for value changes
        valEl.style.transition = 'background-color 0.3s';
        valEl.style.backgroundColor = '#28a745';
        setTimeout(() => {
          valEl.style.backgroundColor = '';
        }, 300);
        console.log(`Updated tag ${tag.id} from ${oldVal} to ${newVal}`);
      }
    });
  });

  // Group filtering functionality
  if (typeof App.changeGroup === 'undefined') {
    App.changeGroup = function(groupValue) {
      const url = new URL(window.location);
      if (groupValue === '__all__') {
        url.searchParams.delete('group');
      } else {
        url.searchParams.set('group', groupValue);
      }
      window.location.href = url.toString();
    };
  }

  // Write functionality for subdashboard tags
  document.addEventListener('click', function(e) {
    if (e.target.closest('.write-btn')) {
      const btn = e.target.closest('.write-btn');
      const tagId = btn.dataset.tagId;
      const tagName = btn.dataset.tagName;
      
      Swal.fire({
        title: `Write Value to ${tagName}`,
        input: 'number',
        inputLabel: 'Enter value:',
        inputPlaceholder: 'Enter new value',
        showCancelButton: true,
        confirmButtonText: 'Write',
        cancelButtonText: 'Cancel',
        inputValidator: (value) => {
          if (!value && value !== '0') {
            return 'Please enter a value';
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const value = result.value;
          
          // Show loading
          Swal.fire({
            title: 'Writing...',
            text: `Setting ${tagName} to ${value}`,
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          // Send write request
          fetch(`/api/tags/${parseInt(tagId)}/write`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              value: parseFloat(value)
            })
          })
          .then(response => response.json())
          .then(data => {
            Swal.close();
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: `Successfully wrote ${value} to ${tagName}`,
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Write Failed',
                text: data.error || 'Failed to write value'
              });
            }
          })
          .catch(error => {
            Swal.close();
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Network error occurred'
            });
          });
        }
      });
    }
  });

  // Group selection functionality for Add Tag modal

  // Toggle new group input visibility
  function toggleNewGroupInput() {
    const newGroupSection = document.getElementById('newGroupSection');
    const targetGroupSelect = document.getElementById('target_group');
    const toggleBtn = document.getElementById('toggleNewGroup');
    const newGroupInput = document.getElementById('new_group_name');
    
    if (newGroupSection.style.display === 'none') {
      // Show new group input
      newGroupSection.style.display = 'block';
      targetGroupSelect.disabled = true;
      targetGroupSelect.value = '';
      newGroupInput.required = true;
      toggleBtn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel';
      toggleBtn.className = 'btn btn-outline-danger';
    } else {
      // Hide new group input
      newGroupSection.style.display = 'none';
      targetGroupSelect.disabled = false;
      newGroupInput.required = false;
      newGroupInput.value = '';
      toggleBtn.innerHTML = '<i class="bi bi-plus-circle"></i> New';
      toggleBtn.className = 'btn btn-outline-secondary';
    }
  }

  // Listen for alarm events from subdashboard tags
  socket.on('alarm_event', function(data) {
    console.log('Received alarm event in subdash:', data);
    
    // Only show notifications for tags that belong to current subdashboard
    // (The modbus_service already filters by subdashboard, so we can trust this event)
    if (window.notificationSystem) {
      window.notificationSystem.addNotification({
        id: Date.now() + Math.random(),
        title: data.title || 'Alarm Alert',
        message: data.message || 'Alarm condition detected',
        level: data.level || 'Critical',
        created_at: new Date().toISOString(),
        status: data.status || 'Active'
      });
    }
    
    // Also show browser toast notification for important alarms
    if (data.status === 'INCOMING' && data.level === 'Critical') {
      // Show browser notification if permission granted
      if (Notification.permission === 'granted') {
        new Notification(`üö® ${data.title}`, {
          body: data.message,
          icon: '/static/favicon.ico'
        });
      }
    }
  });

  // Request notification permission on page load
  if (Notification.permission === 'default') {
    Notification.requestPermission();
  }

  }); // End of DOMContentLoaded

</script>
{% endblock %}