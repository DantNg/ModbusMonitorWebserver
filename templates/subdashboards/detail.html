{% extends "base.html" %}
{% set page_title = "Sub Dashboard: " ~ subdash.name %}
{% block content %}

{% if groups %}
  <h5 class="mt-4">Tag Groups</h5>
  <div class="row mb-4">
    {% for group in groups %}
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card border-0 shadow-soft">
          <div class="card-header bg-info text-white fw-bold d-flex justify-content-between align-items-center">
            <span>{{ group.name }}</span>
            <form method="post" action="{{ url_for('subdash_bp.delete_group', sid=subdash.id, gid=group.id) }}" 
                  class="d-inline" onsubmit="return confirm('Are you sure you want to delete the group \'{{ group.name }}\'?')">
              <button type="submit" class="btn btn-sm btn-outline-light" title="Delete Group">
                <i class="bi bi-trash">Delete</i>
              </button>
            </form>
          </div>
          <div class="card-body">
            {% if group.tags %}
              <ul class="list-group list-group-flush">
                {% for tag in group.tags %}
                  <li class="list-group-item">{{ tag.name }} <span class="text-muted">({{ tag.unit }})</span></li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-muted small">No tags in this group.</div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="card border-0 shadow-soft mb-3">
  <div class="card-body d-flex justify-content-between align-items-center">
    <h5 class="mb-0">{{ subdash.name }}</h5>
    <div>
      <a href="{{ url_for('subdash_bp.list_subdash') }}" class="btn btn-sm btn-outline-secondary">← Back</a>
      <button class="btn btn-sm btn-success ms-2" data-bs-toggle="modal" data-bs-target="#addTagModal">
        + Add Tag
      </button>
      <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#addGroupModal">
        + Add Tag Group
      </button>
    </div>
  </div>
</div>

<div class="row g-4">
  {% for tag in tags %}
  <div class="col-12 col-md-6 col-xl-4">
    <div class="card border-0 shadow-soft tile">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <div class="fw-semibold">{{ tag.name }}</div>
            <div class="text-muted small">{{ tag.description or '&nbsp;' }}</div>
          </div>
          <span class="badge bg-secondary">{{ tag.datatype }}</span>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <div>
            {% if tag.alarm_status == "Normal" %}
            <span class="badge bg-success">Normal</span>
            {% else %}
            <span class="badge bg-danger">Alarm</span>
            {% endif %}
          </div>
          <div class="small text-muted">
            <i class="bi bi-clock"></i> {{ tag.ts }}
          </div>
        </div>
        <div class="value-row d-flex align-items-center justify-content-center flex-column">
          <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
            {{ tag.value if tag.value is not none else '—' }}
          </div>
          <div class="unit">{{ tag.unit }}</div>
        </div>
        <div class="meter mt-2">
          <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:0%"></div>
        </div>
        <div class="text-end small text-muted mt-1" id="tag-ts-{{ tag.id }}"></div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-12 text-center text-muted py-4">No tags selected.</div>
  {% endfor %}
</div>

<!-- Modal: Add Tag -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTagModalLabel">Add Tag to {{ subdash.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('subdash_bp.add_tag_to_subdash', sid=subdash.id) }}">
        <div class="modal-body">
          {% if all_tags %}
          <div class="mb-3">
            <label for="tag_id" class="form-label">Select Tag</label>
            <select id="tag_id" name="tag_id" class="form-select">
              {% for tag in all_tags %}
              <option value="{{ tag.id }}">{{ tag.tag_name }} ({{ tag.device_name }})</option>
              {% endfor %}
            </select>
          </div>
          {% else %}
          <div class="alert alert-warning mb-0">No tags available to add.</div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          {% if all_tags %}
          <button type="submit" class="btn btn-success">Add Tag</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Add Tag Group -->
<div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addGroupModalLabel">Add Tag Group to {{ subdash.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('subdash_bp.add_group_to_subdash', sid=subdash.id) }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="group_name" class="form-label">Group Name</label>
            <input type="text" id="group_name" name="group_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="group_tags" class="form-label">Select Tags for Group</label>
            <select id="group_tags" name="group_tags" class="form-select" multiple required>
              {% for tag in all_tags %}
              <option value="{{ tag.id }}">{{ tag.tag_name }} ({{ tag.device_name }})</option>
              {% endfor %}
            </select>
            <small class="text-muted">Hold Ctrl/Command to select multiple tags.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Group</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  App.startDashboard('/api/tags?subdash={{ subdash.id }}');
  const socket = io();
  if (window.location.pathname.startsWith('/subdashboards/')) {
    socket.emit('join', { room: 'subdashboard_{{ subdash.id }}' });
  }

</script>
{% endblock %}
