{% extends "base.html" %}
{% set page_title = "Sub Dashboard: " ~ subdash.name %}
{% block content %}

<div class="card border-0 shadow-soft mb-3">
  <div class="card-body d-flex flex-wrap gap-3 align-items-center">
    <div>
      <div class="text-muted small">Group</div>
      <select id="sel-group" class="form-select form-select-sm" onchange="App.changeGroup(this.value)">
        <option value="__all__" {{ 'selected' if current_group=='__all__' else '' }}>All Groups</option>
        {% for group in groups %}
        <option value="{{ group.id }}" {{ 'selected' if current_group==group.id|string else '' }}>
          {{ group.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <a href="{{ url_for('subdash_bp.list_subdash') }}" class="btn btn-sm btn-outline-secondary">‚Üê Back</a>
      <!-- <button id="testSocketBtn" class="btn btn-sm btn-info">üîå Test Socket</button>
      <button id="forceRefreshBtn" class="btn btn-sm btn-warning">üîÑ Force Refresh</button> -->
      {% if session.get("role") == "admin" %}
      <div class="dropdown"></div>
      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="settingsDropdown"
        data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-gear"></i> Settings
      </button>
      <ul class="dropdown-menu" aria-labelledby="settingsDropdown">
        <li>
          <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addTagModal">+ Add Tag</button>
        </li>
        <li>
          <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addGroupModal">+ Add Tag Group</button>
        </li>
      </ul>
    </div>
    {% endif %}
  </div>
</div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="alert-container mb-3">
  {% for category, message in messages %}
  <div
    class="alert alert-{{ 'danger' if category == 'error' else 'warning' if category == 'warning' else 'success' }} alert-dismissible fade show"
    role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endwith %}

<div id="group-panels">
  {% if current_group == '__all__' %}
  {% for group in groups %}
  <div class="card border-0 shadow-soft mb-4">
    <div class="card-header bg-info text-white rounded-top fw-bold d-flex justify-content-between align-items-center">
      <span>{{ group.name }}</span>
      {% if session.get("role") == "admin" %}
      <button class="btn btn-sm btn-outline-light delete-group-btn" data-group-id="{{ group.id }}" data-group-name="{{ group.name }}" title="Delete Group">
        <i class="bi bi-trash"></i>
      </button>
      {% endif %}
    </div>
    <div class="card-body">
      <div class="row g-4">
        {% for tag in group.tags %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card border-0 shadow-soft tile">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-semibold">{{ tag.name }}</div>
                  <div class="text-muted small">{{ tag.description or ' ' }}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  {% if tag.function_code == 1 or tag.function_code == 3 or tag.function_code == "1" or
                  tag.function_code == "3" %}
                  <button class="btn btn-sm btn-outline-primary write-btn" data-tag-id="{{ tag.id }}"
                    data-tag-name="{{ tag.name }}" title="Write Value">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  {% endif %}
                  {% if session.get("role") == "admin" %}

                  <button class="btn btn-sm btn-outline-danger remove-tag-btn" data-tag-id="{{ tag.id }}"
                    data-tag-name="{{ tag.name }}" data-group-id="{{ group.id }}" title="Remove tag from group">

                    <i class="bi bi-x-circle"></i>

                  </button>

                  {% endif %}
                </div>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <div>
                  {% if tag.alarm_status == "Normal" %}
                  <span class="badge bg-success">Normal</span>
                  {% else %}
                  <span class="badge bg-danger">Alarm</span>
                  {% endif %}
                </div>
                <!-- <div class="small text-muted">
                  <i class="bi bi-clock"></i> {{ tag.ts }}
                </div> -->
              </div>
              <div class="value-row d-flex align-items-center justify-content-center flex-column">
                <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
                  {{ tag.value }}
                </div>
                <div class="unit">Unit {{ tag.unit }}</div>
              </div>
              <div class="meter mt-2">
                <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:100%"></div>
              </div>
              <div class="text-end small text-muted mt-1" id="tag-ts-{{ tag.id }}"></div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  {% for group in groups %}
  {% if current_group == group.id|string %}
  <div class="card border-0 shadow-soft mb-4">
    <div class="card-header bg-info text-white rounded-top fw-bold d-flex justify-content-between align-items-center">
      <span>{{ group.name }}</span>
      {% if session.get("role") == "admin" %}
      <button class="btn btn-sm btn-outline-light delete-group-btn" data-group-id="{{ group.id }}" data-group-name="{{ group.name }}" title="Delete Group">
        <i class="bi bi-trash"></i>
      </button>
      {% endif %}
    </div>
    <div class="card-body">
      <div class="row g-4">
        {% for tag in group.tags %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card border-0 shadow-soft tile">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-semibold">{{ tag.name }}</div>
                  <div class="text-muted small">{{ tag.description or ' ' }}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <!-- Debug FC: {{ tag.function_code }} Type: {{ tag.function_code.__class__.__name__ }} -->`n{% if
                  tag.function_code == 1 or tag.function_code == 3 or tag.function_code == "1" or tag.function_code ==
                  "3" %}
                  <button class="btn btn-sm btn-outline-primary write-btn" data-tag-id="{{ tag.id }}"
                    data-tag-name="{{ tag.name }}" title="Write Value">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  {% endif %}
                  {% if session.get("role") == "admin" %}

                  <button class="btn btn-sm btn-outline-danger remove-tag-btn" data-tag-id="{{ tag.id }}"
                    data-tag-name="{{ tag.name }}" data-group-id="{{ group.id }}" title="Remove tag from group">

                    <i class="bi bi-x-circle"></i>

                  </button>

                  {% endif %}
                </div>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <div>
                  {% if tag.alarm_status == "Normal" %}
                  <span class="badge bg-success">Normal</span>
                  {% else %}
                  <span class="badge bg-danger">Alarm</span>
                  {% endif %}
                </div>
                <!-- <div class="small text-muted">
                  <i class="bi bi-clock"></i> {{ tag.ts }}
                </div> -->
              </div>
              <div class="value-row d-flex align-items-center justify-content-center flex-column">
                <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
                  {{ tag.value }}
                </div>
                <div class="unit">Unit {{ tag.unit }}</div>
              </div>
              <div class="meter mt-2">
                <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:100%"></div>
              </div>
              <div class="text-end small text-muted mt-1" id="tag-ts-{{ tag.id }}"></div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}
  {% endif %}
</div>


<!-- Modal: Add Tag -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTagModalLabel">Add Tag to {{ subdash.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addTagForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="tag_id" class="form-label">Select Tag</label>
            <select id="tag_id" name="tag_id" class="form-select" required>
              <option value="">Choose a tag...</option>
              {% for tag in all_tags %}
              <option value="{{ tag.id }}">{{ tag.tag_name }} ({{ tag.device_name }})</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="target_group" class="form-label">Add to Group</label>
            <div class="input-group">
              <select id="target_group" name="target_group" class="form-select">
                <option value="">Select existing group...</option>
                {% for group in groups %}
                <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-outline-secondary" type="button" id="toggleNewGroup"
                onclick="toggleNewGroupInput()">
                <i class="bi bi-plus-circle"></i> New
              </button>
            </div>
            <small class="text-muted">Select an existing group or create a new one</small>
          </div>

          <!-- New Group Input (hidden by default) -->
          <div class="mb-3" id="newGroupSection" style="display: none;">
            <label for="new_group_name" class="form-label">New Group Name</label>
            <input type="text" id="new_group_name" name="new_group_name" class="form-control"
              placeholder="Enter group name...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Tag</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Add Tag Group -->
<div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addGroupModalLabel">Add Tag Group to {{ subdash.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addGroupForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="group_name" class="form-label">Group Name</label>
            <input type="text" id="group_name" name="group_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="group_tags" class="form-label">Select Tags for Group</label>
            <select id="group_tags" name="group_tags" class="form-select" multiple required>
              {% for tag in all_tags %}
              <option value="{{ tag.id }}">{{ tag.tag_name }} ({{ tag.device_name }})</option>
              {% endfor %}
            </select>
            <small class="text-muted">Hold Ctrl/Command to select multiple tags.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Group</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
  // Initialize Socket.IO client
  const socket = io();

  console.log('Initializing Socket.IO listeners for subdashboard...');
  // Wrap everything in DOMContentLoaded to ensure buttons exist
  document.addEventListener('DOMContentLoaded', function () {

    // App globals for subdashboard
    window.App = window.App || {};

    const currentSubdashId = "{{ subdash.id }}";
    const currentGroup = "{{ current_group }}";


    // Change group function
    App.changeGroup = function (groupId) {
      console.log(`üîÑ Changing from group '${currentGroup}' to group '${groupId}'`);

      // Leave current room before navigating
      if (typeof socket !== 'undefined') {
        socket.emit('leave', { room: `subdashboard_${currentSubdashId}` });
        console.log(`Left subdashboard room: subdashboard_${currentSubdashId}`);
      }

      // Navigate to new group (this will reload the page)
      const url = new URL(window.location);
      url.searchParams.set('group', groupId);
      window.location.href = url.toString();
    };

    // Initialize App for subdashboard
    // App.startDashboard('/api/tags?subdash={{ subdash.id }}');

    // Write functionality for subdashboard tags
    document.addEventListener('click', function (e) {
      if (e.target.closest('.write-btn')) {
        const btn = e.target.closest('.write-btn');
        const tagId = btn.dataset.tagId;
        const tagName = btn.dataset.tagName;

        Swal.fire({
          title: `Write Value to ${tagName}`,
          input: 'number',
          inputLabel: 'Enter value:',
          inputPlaceholder: 'Enter new value',
          showCancelButton: true,
          confirmButtonText: 'Write',
          cancelButtonText: 'Cancel',
          inputValidator: (value) => {
            if (!value && value !== '0') {
              return 'Please enter a value';
            }
          }
        }).then((result) => {
          if (result.isConfirmed) {
            const value = result.value;

            // Show loading
            Swal.fire({
              title: 'Writing...',
              text: `Setting ${tagName} to ${value}`,
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // Send write request
            fetch(`/api/tags/${parseInt(tagId)}/write`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                value: parseFloat(value)
              })
            })
              .then(response => response.json())
              .then(data => {
                Swal.close();
                if (data.success) {
                  Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: `Successfully wrote ${value} to ${tagName}`,
                    timer: 2000,
                    showConfirmButton: false
                  });
                } else {
                  Swal.fire({
                    icon: 'error',
                    title: 'Write Failed',
                    text: data.error || 'Failed to write value'
                  });
                }
              })
              .catch(error => {
                Swal.close();
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Network error occurred'
                });
              });
          }
        });
      }
    });

    // Handle Add Tag form submission
    const addTagForm = document.getElementById('addTagForm');
    if (addTagForm) {
      addTagForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(addTagForm);
        const tagId = formData.get('tag_id');
        const targetGroup = formData.get('target_group');
        const newGroupName = formData.get('new_group_name');
        
        if (!tagId) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Please select a tag'
          });
          return;
        }
        
        // Show loading
        Swal.fire({
          title: 'Adding Tag...',
          text: 'Adding tag to subdashboard',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        // Send AJAX request
        fetch(`/subdash/${currentSubdashId}/add_tag`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `tag_id=${tagId}&target_group=${targetGroup}&new_group_name=${newGroupName}`
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: data.message || 'Tag added successfully',
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
              // Close modal and reload page
              const modal = bootstrap.Modal.getInstance(document.getElementById('addTagModal'));
              modal.hide();
              window.location.href = window.location.href + '?t=' + Date.now();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.error || 'Failed to add tag'
            });
          }
        })
        .catch(error => {
          console.error('Add tag error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to add tag'
          });
        });
      });
    }

    // Handle Add Group form submission
    const addGroupForm = document.getElementById('addGroupForm');
    if (addGroupForm) {
      addGroupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(addGroupForm);
        const groupName = formData.get('group_name');
        const selectedTags = Array.from(document.getElementById('group_tags').selectedOptions).map(option => option.value);
        
        if (!groupName || selectedTags.length === 0) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Please enter group name and select at least one tag'
          });
          return;
        }
        
        // Show loading
        Swal.fire({
          title: 'Creating Group...',
          text: 'Creating new tag group',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        // Prepare form data
        const formBody = `group_name=${encodeURIComponent(groupName)}&${selectedTags.map(tag => `group_tags=${tag}`).join('&')}`;
        
        // Send AJAX request
        fetch(`/subdash/${currentSubdashId}/add_group`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formBody
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: data.message || `Group "${groupName}" created successfully`,
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
              // Close modal and reload page
              const modal = bootstrap.Modal.getInstance(document.getElementById('addGroupModal'));
              modal.hide();
              window.location.href = window.location.href + '?t=' + Date.now();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.error || 'Failed to create group'
            });
          }
        })
        .catch(error => {
          console.error('Add group error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to create group'
          });
        });
      });
    }

    // Request notification permission on page load
    if (Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Handle remove tag from group
    document.addEventListener('click', function (e) {
      if (e.target.closest('.remove-tag-btn')) {
        e.preventDefault();
        const btn = e.target.closest('.remove-tag-btn');
        const tagId = btn.dataset.tagId;
        const tagName = btn.dataset.tagName;
        const groupId = btn.dataset.groupId;

        Swal.fire({
          title: 'Remove Tag',
          text: `Are you sure you want to remove "${tagName}" from this group?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading
            Swal.fire({
              title: 'Removing...',
              text: 'Removing tag from group',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // Send AJAX request
            fetch(`/subdash/${currentSubdashId}/remove_tag`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: `tag_id=${tagId}&group_id=${groupId}`
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Success!',
                  text: data.message || `Tag "${tagName}" removed successfully`,
                  timer: 2000,
                  showConfirmButton: false
                }).then(() => {
                  // Hard reload page to bypass cache
                  window.location.href = window.location.href + '?t=' + Date.now();
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: data.error || 'Failed to remove tag'
                });
              }
            })
            .catch(error => {
              console.error('Remove tag error:', error);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to remove tag'
              });
            });
          }
        });
      }
    });

    // Handle delete group
    document.addEventListener('click', function (e) {
      if (e.target.closest('.delete-group-btn')) {
        e.preventDefault();
        const btn = e.target.closest('.delete-group-btn');
        const groupId = btn.dataset.groupId;
        const groupName = btn.dataset.groupName;

        Swal.fire({
          title: 'Delete Group',
          text: `Are you sure you want to delete the group "${groupName}"?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading
            Swal.fire({
              title: 'Deleting...',
              text: 'Deleting group',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // Send AJAX request
            fetch(`/subdash/${currentSubdashId}/group/${groupId}/delete`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Deleted!',
                  text: data.message || `Group "${groupName}" deleted successfully`,
                  timer: 2000,
                  showConfirmButton: false
                }).then(() => {
                  // Hard reload page to bypass cache
                  window.location.href = window.location.href + '?t=' + Date.now();
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: data.error || 'Failed to delete group'
                });
              }
            })
            .catch(error => {
              console.error('Delete group error:', error);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to delete group'
              });
            });
          }
        });
      }
    });

  }); // End of DOMContentLoaded

  // Convert function code to integer for comparison
  function getFunctionCodeInt(fc) {
    return parseInt(fc) || 0;
  }

  // Check if tag supports write operations
  function canWriteTag(functionCode) {
    const fc = getFunctionCodeInt(functionCode);
    return fc === 1 || fc === 3;
  }

  // Toggle new group input visibility (global function)
  function toggleNewGroupInput() {
    const newGroupSection = document.getElementById('newGroupSection');
    const targetGroupSelect = document.getElementById('target_group');
    const toggleBtn = document.getElementById('toggleNewGroup');
    const newGroupInput = document.getElementById('new_group_name');

    if (newGroupSection.style.display === 'none') {
      // Show new group input
      newGroupSection.style.display = 'block';
      targetGroupSelect.disabled = true;
      targetGroupSelect.value = '';
      newGroupInput.required = true;
      toggleBtn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel';
      toggleBtn.className = 'btn btn-outline-danger';
    } else {
      // Hide new group input
      newGroupSection.style.display = 'none';
      targetGroupSelect.disabled = false;
      newGroupInput.required = false;
      newGroupInput.value = '';
      toggleBtn.innerHTML = '<i class="bi bi-plus-circle"></i> New';
      toggleBtn.className = 'btn btn-outline-secondary';
    }
  }

  // Socket connection variables (global)

  let socketConnected = false;
  let pollingInterval = null;
  const currentSubdashId = "{{ subdash.id }}";
  
  // Timeout tracking for tags
  const TAG_TIMEOUT_MS = 20000; // 20 seconds
  const tagLastUpdates = new Map(); // tag_id -> last_update_timestamp
  let timeoutCheckInterval = null;

  // Check for timed out tags and reset to 0
  function checkTagTimeouts() {
    const now = Date.now();
    
    tagLastUpdates.forEach((lastUpdate, tagId) => {
      if (now - lastUpdate > TAG_TIMEOUT_MS) {
        const valEl = document.getElementById('tag-val-' + tagId);
        if (valEl && valEl.textContent !== '0') {
          console.log(`‚è∞ Tag ${tagId} timeout (${(now - lastUpdate)/1000}s) - resetting to 0`);
          valEl.textContent = '0';
          valEl.style.color = '#666';
          valEl.style.opacity = '0.7';
          
          // Reset bar to 0 width
          const barEl = document.getElementById('tag-bar-' + tagId);
          if (barEl) {
            barEl.style.width = '0%';
            barEl.style.backgroundColor = '#ccc';
          }
          
          // Update timestamp to show timeout
          const tsEl = document.getElementById('tag-ts-' + tagId);
          if (tsEl) {
            tsEl.textContent = 'TIMEOUT';
            tsEl.style.color = '#999';
          }
        }
      }
    });
  }
  // Format value function (matches Python filter)
  function formatValue(value, datatype) {
    
    if (value === null || value === undefined || value === '') return '‚Äî';

    const numValue = parseFloat(value);
    if (isNaN(numValue) || !isFinite(numValue)) return '‚Äî';

    // Fix -0.0 display issue
    const fixedValue = numValue === 0 ? 0 : numValue;

    if (datatype) {
      const datatypeLower = datatype.toLowerCase();
      // Float types: show with .00
      if (['float', 'float32', 'real'].includes(datatypeLower)) {
        return fixedValue.toFixed(2);
      }
      // Integer types: show without decimals if whole number
      else if (['word', 'short', 'dword', 'dint', 'bit', 'int16', 'int32', 'uint16', 'uint32', 'ushort', 'udint'].includes(datatypeLower)) {
        if (Number.isInteger(fixedValue)) {
          return fixedValue.toString();
        } else {
          return fixedValue.toFixed(2); // Fallback for fractional values after scaling
        }
      }
    }

    // Default behavior when no datatype specified
    if (Number.isInteger(fixedValue)) {
      return fixedValue.toString();
    } else {
      return fixedValue.toFixed(2);
    }
  }


  // Real-time socket listener for modbus updates (immediate connection)
  if (typeof socket !== 'undefined') {
    socket.on("modbus_update", function (data) {
      console.log(`Received modbus_update `);
      if (!data || !data.tags) return;

      // Mark that we're receiving socket updates
      socketConnected = true;

      // Debug: Log first update to confirm socket is working
      if (!window.socketUpdateLogged) {
        console.log('‚úÖ First socket update received - real-time connection working!');
        window.socketUpdateLogged = true;
      }

      // Batch DOM updates for better performance
      const updates = [];
      data.tags.forEach(tag => {
        const valEl = document.getElementById('tag-val-' + tag.id);
        if (!valEl) return;

        const oldVal = valEl.textContent;
        const newVal = formatValue(tag.value, tag.datatype);
        console.log(`Tag ${tag.id} value changed from ${oldVal} to ${newVal}`);
        // Only update if value actually changed
        if (oldVal != newVal) {
          updates.push({ valEl, newVal, oldVal, tag });
        }

      });

      // Apply all updates in a single batch
      updates.forEach(({ valEl, newVal, oldVal, tag }) => {
        valEl.textContent = newVal;
        // Track last update time for timeout detection
        tagLastUpdates.set(tag.id, Date.now());
        
        // Reset visual styling (remove timeout indicators)
        valEl.style.color = '';
        valEl.style.opacity = '';
        
        // Update timestamp
        const tsEl = document.getElementById('tag-ts-' + tag.id);
        if (tsEl && tag.ts) {
          tsEl.textContent = tag.ts;
          tsEl.style.color = '';
        }

        // // Add visual feedback for value changes
        // valEl.style.transition = 'all 0.2s ease';
        // valEl.style.backgroundColor = '#e3f2fd';
        const barEl = document.getElementById('tag-bar-' + tag.id);
        if (barEl) {
          barEl.style.width = "100%";
          barEl.style.backgroundColor = "green";

        }
        setTimeout(() => {
          valEl.style.backgroundColor = '';
        }, 1000);
      });

    });

    // Listen for alarm events from subdashboard tags
    socket.on('alarm_event', function (data) {
      console.log('Received alarm event in subdash:', data);

      // Only show notifications for tags that belong to current subdashboard
      if (window.NotificationSystem) {
        window.NotificationSystem.addNotification({
          id: Date.now() + Math.random(),
          title: data.title || 'Alarm Alert',
          message: data.message || 'Alarm condition detected',
          level: data.level || 'Critical',
          created_at: new Date().toISOString(),
          status: data.status || 'Active'
        });
      }

      // Also show browser toast notification for important alarms
      if (data.status === 'INCOMING' && data.level === 'Critical') {
        if (Notification.permission === 'granted') {
          new Notification(`üö® ${data.title}`, {
            body: data.message,
            icon: '/static/favicon.ico',
            tag: `alarm-${data.tag_id}-${Date.now()}`
          });
        }
      }
    });

    console.log('‚úÖ Socket listeners initialized immediately for maximum speed');

    // Join subdashboard room for targeted updates
    socket.emit('join', { room: `subdashboard_${currentSubdashId}` });
    console.log(`Joined room: subdashboard_${currentSubdashId}`);
    
    // Initialize tag tracking and start timeout checker
    document.querySelectorAll('[id^="tag-val-"]').forEach(el => {
      const tagId = el.id.replace('tag-val-', '');
      tagLastUpdates.set(parseInt(tagId), Date.now());
    });
    
    // Start timeout checking interval
    timeoutCheckInterval = setInterval(checkTagTimeouts, 5000); // Check every 5 seconds
    console.log('‚úÖ Tag timeout monitoring started (20s timeout)');

    // Handle reconnection - rejoin room
    socket.on('connect', function () {
      console.log('Socket reconnected, rejoining room...');
      socket.emit('join', { room: `subdashboard_${currentSubdashId}` });
      socketConnected = false; // Reset flag to redetect updates
    });

    socket.on('disconnect', function () {
      console.log('Socket disconnected');
      socketConnected = false;
      
      // Stop timeout checking when disconnected
      if (timeoutCheckInterval) {
        clearInterval(timeoutCheckInterval);
        timeoutCheckInterval = null;
      }
    });
  } else {
    console.warn('Socket not available, falling back to polling only');
  }

  // Polling fallback - check after DOM is ready
  document.addEventListener('DOMContentLoaded', function () {
    // Check if we're receiving socket updates
    setTimeout(function () {
      if (!socketConnected) {
        console.warn('Socket.IO not receiving updates after 2s, falling back to polling');
        pollingInterval = setInterval(function () {
          console.log('Polling fallback - refreshing tags...');
          if (window.App && window.App.refreshTags) {
            window.App.refreshTags();
          }
        }, 2000);
      } else {
        console.log('‚úÖ Real-time socket updates working, polling disabled');
      }
    }, 2000);
  });

  // Cleanup on page unload
  window.addEventListener('beforeunload', function() {
    if (timeoutCheckInterval) {
      clearInterval(timeoutCheckInterval);
    }
    if (pollingInterval) {
      clearInterval(pollingInterval);
    }
  });
</script>

{% endblock %}