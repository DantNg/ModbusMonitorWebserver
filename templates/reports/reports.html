{% extends "base.html" %}
{% set page_title = "Reports" %}
{% block content %}

<!-- Toolbar - Fixed position -->
<div id="toolbar" class="sticky-top bg-white shadow-sm" style="z-index: 100;">
  <form class="card border-0 shadow-soft mb-3" method="get" action="{{ url_for('reports_bp.reports') }}">
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-4">
          <!-- Data Logger -->
          <div class="d-flex flex-column">
            <label class="small text-muted mb-1">Data Logger</label>
            <select class="form-select" name="logger" onchange="this.form.submit()">
              <option value="all" {{ 'selected' if current_logger_id=='all' else '' }}>
                ALL DATALOGGERS
              </option>
              {% for lg in loggers %}
              <option value="{{ lg.id }}" {{ 'selected' if lg.id==current_logger_id else '' }}>
                {{ lg.name }}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <!-- Time Filter -->
          <div class="d-flex flex-column">
            <label class="small text-muted mb-1">Time Filter</label>
            <select class="form-select" name="time_filter" id="timeFilterSelect"
              onchange="toggleCustomRange(); this.form.submit();">
              <option value="all" {{ 'selected' if time_filter=='all' else '' }}>All Time</option>
              <option value="today" {{ 'selected' if time_filter=='today' else '' }}>Today</option>
              <option value="yesterday" {{ 'selected' if time_filter=='yesterday' else '' }}>Yesterday</option>
              <option value="last7days" {{ 'selected' if time_filter=='last7days' else '' }}>Last 7 Days</option>
              <option value="last30days" {{ 'selected' if time_filter=='last30days' else '' }}>Last 30 Days</option>
              <option value="custom" {{ 'selected' if time_filter=='custom' else '' }}>Custom Range</option>
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <!-- Filter Status -->
          {% if time_filter and time_filter != 'all' %}
          <div class="d-flex align-items-end h-100 pb-2">
            <small class="text-muted">
              Active:
              {% if time_filter == 'today' %}
              <span class="badge bg-info">Today</span>
              {% elif time_filter == 'yesterday' %}
              <span class="badge bg-info">Yesterday</span>
              {% elif time_filter == 'last7days' %}
              <span class="badge bg-info">Last 7 Days</span>
              {% elif time_filter == 'last30days' %}
              <span class="badge bg-info">Last 30 Days</span>
              {% elif time_filter == 'custom' %}
              <span class="badge bg-info">Custom Range</span>
              {% endif %}
              <a href="{{ url_for('reports_bp.reports', logger=current_logger_id) }}" class="text-decoration-none ms-1"
                title="Clear filter">✕</a>
            </small>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Custom Date Range (shown when custom is selected) -->
      <div class="row mb-3 {% if time_filter != 'custom' %}d-none{% endif %}" id="customDateRange">
        <div class="col-md-4">
          <label class="small text-muted mb-1">From Date:</label>
          <input type="datetime-local" class="form-control" name="from" value="{{ from_dt|default('', true) }}">
        </div>
        <div class="col-md-4">
          <label class="small text-muted mb-1">To Date:</label>
          <input type="datetime-local" class="form-control" name="to" value="{{ to_dt|default('', true) }}">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary">Apply Filter</button>
        </div>
      </div>

      <!-- Search & Export -->
      <div class="d-flex gap-3 align-items-center justify-content-between">
        <div class="position-relative" style="min-width:260px;">
          <span class="position-absolute top-50 translate-middle-y ms-3 opacity-50">🔎</span>
          <input id="q" class="form-control ps-5" placeholder="Search..." oninput="filterRows(this.value)">
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-primary" onclick="exportReport('xlsx')">Export XLSX</button>

          <!-- Clear Data buttons - chỉ admin -->
          {% if session.get("role") == "admin" %}
          <div class="btn-group ms-2">
            <button class="btn btn-outline-danger btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-trash"></i> Clear Data
            </button>
            <ul class="dropdown-menu">
              {% if current_logger_id != 'all' %}
                <li>
                <form id="clear-logger-form" method="post" action="{{ url_for('reports_bp.clear_logger_report_data', logger_id=current_logger_id) }}" style="display:inline;">
                  <button type="submit" class="dropdown-item text-warning"
                  onclick="return confirm('Clear all data for {{ current_logger_name }}? This cannot be undone!')">
                  <i class="bi bi-trash"></i> Clear {{ current_logger_name }}
                  </button>
                </form>
                </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              {% endif %}

              <li>
                <form method="post" action="{{ url_for('reports_bp.clear_all_report_data') }}"
                  onsubmit="return confirm('Clear ALL report data from ALL loggers? This cannot be undone!')"
                  style="display:inline;">
                  <button type="submit" class="dropdown-item text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Clear All Data
                  </button>
                </form>
              </li>
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Back to top button -->
<button id="backToTop" class="btn btn-primary position-fixed shadow"
  style="bottom: 20px; right: 20px; z-index: 1000; border-radius: 50%; width: 50px; height: 50px;"
  onclick="scrollToTop()" title="Back to Top">
  <i class="bi bi-arrow-up fs-5"></i>
</button>

<!-- Table -->
<div class="card border-0 shadow-soft">
  <div class="table-responsive">
    <table id="tbl" class="table table-hover align-middle mb-0">
      <thead class="table-dark-subtle">
        <tr>
          <th style="width:220px;">TIMESTAMP</th>
          {% for c in columns %}
          {% if c != 'timestamp' %}
          <th class="text-nowrap">{{ c|upper }}</th>
          {% endif %}
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% if items and items|length %}
        {% for row in items %}
        <tr>
          {% for c in columns %}
          <td>{{ row[c] }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="{{ columns|length }}">No data</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="card-footer small text-muted d-flex justify-content-between">
    <div>Showing {{ items|length if items else 0 }} rows</div>
    <div>Tip: Use Export → open with Excel</div>
  </div>
</div>
<!-- thêm thư viện XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  // Back to top functionality
  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Show/hide back to top button
  window.addEventListener('scroll', function () {
    const backToTop = document.getElementById('backToTop');
    if (window.scrollY > 200) {  // Hiện sớm hơn (200px thay vì 300px)
      backToTop.style.display = 'block';
    } else {
      backToTop.style.display = 'none';
    }
  });

  // Initialize - show button if already scrolled
  document.addEventListener('DOMContentLoaded', function () {
    const backToTop = document.getElementById('backToTop');
    if (window.scrollY > 200) {
      backToTop.style.display = 'block';
    }
  });

  // Toggle custom date range visibility
  function toggleCustomRange() {
    const select = document.getElementById('timeFilterSelect');
    const customRange = document.getElementById('customDateRange');
    if (select.value === 'custom') {
      customRange.classList.remove('d-none');
    } else {
      customRange.classList.add('d-none');
    }
  }

  // Lọc nhanh client-side
  function filterRows(q) {
    q = (q || '').toLowerCase();
    document.querySelectorAll('#tbl tbody tr').forEach(tr => {
      if (tr.querySelector('td[colspan]')) return; // hàng "No data"
      tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  }


  function exportReport(kind) {
    const rows = [];
    const currentLoggerName = document.querySelector('select[name="logger"] option:checked').textContent;
    const fromDate = document.querySelector('input[name="from"]').value;
    const toDate = document.querySelector('input[name="to"]').value;
    // ==== Thêm dòng tiêu đề bảng và thời gian ====
    rows.push(["DATALOGGER TRUY VẤN", currentLoggerName]);
    rows.push(["FROM DATE:", fromDate]);
    rows.push(["TO DATE:", toDate]);
    rows.push([]);
    rows.push([]);
    rows.push([]);

    // ==== Header ====
    const header = [];
    document.querySelectorAll('#tbl thead th').forEach(th => header.push(th.textContent.trim()));
    rows.push(header);

    // ==== Data ====
    document.querySelectorAll('#tbl tbody tr').forEach(tr => {
      if (tr.style.display === 'none') return; // tôn trọng filter
      const tds = [...tr.querySelectorAll('td')];
      if (tds.length === 0) return;
      rows.push(tds.map(td => (td.textContent || '').trim()));
    });

    if (kind === 'xlsx') {
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Report");
      XLSX.writeFile(wb, `report_{{ current_logger_name|replace(' ','_') }}.xlsx`);
    } else {
      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {
        href: url,
        download: `report_{{ current_logger_name|replace(' ','_') }}.csv`
      });
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
  }
</script>

{% endblock %}