{% extends "base.html" %}
{% set page_title = "Dashboard" %}

{% block content %}
<div class="card border-0 shadow-soft mb-3">
  <div class="card-body d-flex flex-wrap gap-3 align-items-center">
    <div>
      <div class="text-muted small">Device</div>
      <select id="sel-device" class="form-select form-select-sm" onchange="App.changeDevice(this.value)">
        <option value="__all__" {{ 'selected' if current_device=='__all__' else '' }}>All Devices</option>
        {% for dev in devices %}
        <option value="{{ dev.id }}" {{ 'selected' if current_device==dev.id|string else '' }}>
          {{ dev.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="ms-auto small text-muted">Auto refresh: 3s</div>
  </div>
</div>

<div id="device-panels">
  {% if current_device == '__all__' %}
  {% for dev in devices %}
  <div class="card border-0 shadow-soft mb-4">
    <div class="card-header bg-primary text-white rounded-top fw-bold">{{ dev.name }}</div>
    <div class="card-body">
      <div class="row g-4">
        {% for tag in dev.tags %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card border-0 shadow-soft tile">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-semibold">{{ tag.name }}</div>
                  <div class="text-muted small">{{ tag.description or ' ' }}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  {% if tag.function_code == 1 or tag.function_code == 3 %}
                  <button class="btn btn-sm btn-outline-primary write-btn" 
                          data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}"
                          title="Write Value">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  {% endif %}
                </div>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <div>
                  {% if tag.alarm_status == "Normal" %}
                  <span class="badge bg-success">Normal</span>
                  {% else %}
                  <span class="badge bg-danger">Alarm</span>
                  {% endif %}
                </div>
                <div class="small text-muted">
                  <i class="bi bi-clock"></i> {{ tag.ts }}
                </div>
              </div>
              <div class="value-row d-flex align-items-center justify-content-center flex-column">
                <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
                  {{ tag.value|format_value(tag.datatype) }}
                </div>
                <div class="unit">Unit {{ tag.unit }}</div>
              </div>
              <div class="meter mt-2">
                <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  {% for dev in devices %}
  {% if current_device == dev.id|string %}
  <div class="card border-0 shadow-soft mb-4">
    <div class="card-header bg-primary text-white rounded-top fw-bold">{{ dev.name }}</div>
    <div class="card-body">
      <div class="row g-4">
        {% for tag in dev.tags %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card border-0 shadow-soft tile">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-semibold">{{ tag.name }}</div>
                  <div class="text-muted small">{{ tag.description or ' ' }}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  {% if tag.function_code == 1 or tag.function_code == 3 %}
                  <button class="btn btn-sm btn-outline-primary write-btn" 
                          data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}"
                          title="Write Value">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  {% endif %}
                </div>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <div>
                  {% if tag.alarm_status == "Normal" %}
                  <span class="badge bg-success">Normal</span>
                  {% else %}
                  <span class="badge bg-danger">Alarm</span>
                  {% endif %}
                </div>
                <div class="small text-muted">
                  <i class="bi bi-clock"></i> {{ tag.ts }}
                </div>
              </div>
              <div class="value-row d-flex align-items-center justify-content-center flex-column">
                <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
                  {{ tag.value|format_value(tag.datatype) }}
                </div>
                <div class="unit">Unit {{ tag.unit }}</div>
              </div>
              <div class="meter mt-2">
                <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}
  {% endif %}


  <div class="ms-auto d-flex gap-2 align-items-center">
    <!-- Nút Add Subdashboard -->
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('subdash_bp.list_subdash') }}">
      + Add Subdashboard
    </a>
    <div class="small text-muted">Auto refresh: 3s</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  window.App = window.App || {};
  App.changeDevice = function (deviceId) {
    // Leave current room before navigating
    const currentDevice = "{{ current_device }}";
    if (currentDevice === '__all__') {
      socket.emit('leave', { room: 'dashboard_all' });
    } else {
      socket.emit('leave', { room: `dashboard_device_${currentDevice}` });
    }
    
    // Navigate to new device
    window.location.search = '?device=' + deviceId;
  };
  const currentDevice = "{{ current_device }}";
  const apiUrl = `/api/tags?device=${currentDevice}`;
  const socket = io();
  
  // Join the appropriate room based on current device view
  if (window.location.pathname.startsWith('/dashboard')) {
    if (currentDevice === '__all__') {
      socket.emit('join', { room: 'dashboard_all' });
    } else {
      socket.emit('join', { room: `dashboard_device_${currentDevice}` });
    }
  }


  const tagUpdateTimers = {};
  
  // Format value function (matches Python filter)
  function formatValue(value, datatype) {
    if (value === null || value === undefined || value === '') return '—';
    
    const numValue = parseFloat(value);
    if (isNaN(numValue) || !isFinite(numValue)) return '—';
    
    // Fix -0.0 display issue
    const fixedValue = numValue === 0 ? 0 : numValue;
    
    if (datatype) {
      const datatypeLower = datatype.toLowerCase();
      
      // IEEE754 Float types: show with .00
      if (['float', 'float32', 'real', 'float_inverse'].includes(datatypeLower)) {
        return fixedValue.toFixed(2);
      }
      // IEEE754 Double types: show with more precision
      else if (['double', 'double_inverse'].includes(datatypeLower)) {
        return fixedValue.toFixed(4);
      }
      // Display formats
      else if (datatypeLower === 'hex') {
        const intVal = Math.round(Math.abs(fixedValue));
        return '0x' + intVal.toString(16).toUpperCase();
      }
      else if (datatypeLower === 'binary') {
        const intVal = Math.round(Math.abs(fixedValue));
        return '0b' + intVal.toString(2);
      }
      else if (datatypeLower === 'raw') {
        return fixedValue.toString(); // Raw unprocessed value
      }
      // Integer types: show without decimals if whole number
      else if (['word', 'short', 'dword', 'dint', 'bit', 'signed', 'unsigned', 'long', 'int16', 'int32', 'uint16', 'uint32', 'ushort', 'udint'].includes(datatypeLower)) {
        if (Number.isInteger(fixedValue)) {
          return fixedValue.toString();
        } else {
          return fixedValue.toFixed(2); // Fallback for fractional values after scaling
        }
      }
    }
    
    // Default behavior when no datatype specified
    if (Number.isInteger(fixedValue)) {
      return fixedValue.toString();
    } else {
      return fixedValue.toFixed(2);
    }
  }
  
  // Listen for real-time modbus updates (new high-speed format) - Optimized for maximum speed
  socket.on("modbus_update", function (data) {
    if (!data || !data.tags) return;
    
    // Batch DOM updates for better performance at high speeds
    const updates = [];
    
    data.tags.forEach(tag => {
      const valEl = document.getElementById('tag-val-' + tag.id);
      if (!valEl) return;

      const oldVal = valEl.textContent;
      const newVal = formatValue(tag.value, tag.datatype);

      // Only update if value actually changed (performance optimization)
      if (oldVal !== newVal) {
        updates.push({ valEl, newVal, oldVal, tag });
      }
    });
    
    // Apply all updates in a single batch
    updates.forEach(({ valEl, newVal, oldVal, tag }) => {
      // Update text
      valEl.textContent = newVal;
      const tsEl = document.getElementById('tag-ts-' + tag.id);
      if (tsEl) tsEl.textContent = tag.ts || '';

      // Always show activity bar for real-time updates (green = fresh data)
      const barEl = document.getElementById('tag-bar-' + tag.id);
      if (barEl) {
        barEl.style.width = "100%";
        barEl.style.backgroundColor = "green";

        if (tagUpdateTimers[tag.id]) clearTimeout(tagUpdateTimers[tag.id]);
        tagUpdateTimers[tag.id] = setTimeout(() => {
          barEl.style.backgroundColor = "";
          barEl.style.width = "0%"; // Fade after 10s for faster feedback
        }, 10000);
      }
    });
    
    // Debug log only for significant batches to reduce console spam
    if (updates.length > 0) {
      console.log(`[${new Date().toLocaleTimeString()}] Device ${data.device_name || data.device_id}: ${updates.length}/${data.tag_count} tags updated, ${data.latency_ms}ms latency, seq: ${data.seq}`);
    }
  });
  
  // Keep legacy listener for backward compatibility
  socket.on("update_tags", function (data) {
    if (!data || !data.tags) return;

    data.tags.forEach(tag => {
      const valEl = document.getElementById('tag-val-' + tag.id);
      if (!valEl) return;

      const oldVal = valEl.textContent;
      const newVal = formatValue(tag.value, tag.datatype);

      // update text
      valEl.textContent = newVal;
      const tsEl = document.getElementById('tag-ts-' + tag.id);
      if (tsEl) tsEl.textContent = tag.ts || '';

      // chỉ sáng khi có update mới
      if (oldVal !== newVal) {
        const barEl = document.getElementById('tag-bar-' + tag.id);
        if (barEl) {
          barEl.style.width = "100%";
          barEl.style.backgroundColor = "green";

          if (tagUpdateTimers[tag.id]) clearTimeout(tagUpdateTimers[tag.id]);
          tagUpdateTimers[tag.id] = setTimeout(() => {
            barEl.style.backgroundColor = "";
            barEl.style.width = "0%"; // tắt sau 10s nếu không có update
          }, 20000);
        }
      }
    });
  });


  socket.on('alarm_event', function (data) {
    Swal.fire({
      icon: 'error',
      title: data.title,
      html: `<b>${data.message}</b><br>Status: ${data.status}`,
      background: '#1e1e2d',
      color: '#fff',
      confirmButtonText: 'OK'
    });
  });



  // Initial load
  function refreshTags() {
    fetch("/api/tags?device={{ current_device }}")
      .then(res => res.json())
      .then(data => {
        if (!data.tags) return;
        data.tags.forEach(tag => {
          const valEl = document.getElementById('tag-val-' + tag.id);
          if (valEl) valEl.textContent = formatValue(tag.value, tag.datatype);
          const tsEl = document.getElementById('tag-ts-' + tag.id);
          if (tsEl) tsEl.textContent = tag.ts || '';
        });
      });
  }

  // Write functionality for dashboard tags
  document.addEventListener('click', function(e) {
    if (e.target.closest('.write-btn')) {
      const btn = e.target.closest('.write-btn');
      const tagId = btn.dataset.tagId;
      const tagName = btn.dataset.tagName;
      
      Swal.fire({
        title: `Write Value to ${tagName}`,
        input: 'number',
        inputLabel: 'Enter value:',
        inputPlaceholder: 'Enter new value',
        showCancelButton: true,
        confirmButtonText: 'Write',
        cancelButtonText: 'Cancel',
        inputValidator: (value) => {
          if (!value && value !== '0') {
            return 'Please enter a value';
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const value = result.value;
          
          // Show loading
          Swal.fire({
            title: 'Writing...',
            text: `Setting ${tagName} to ${value}`,
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          // Send write request
          fetch(`/api/tags/${parseInt(tagId)}/write`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              value: parseFloat(value)
            })
          })
          .then(response => response.json())
          .then(data => {
            Swal.close();
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: `Successfully wrote ${value} to ${tagName}`,
                timer: 2000,
                showConfirmButton: false
              });
              // Refresh tags to show new value
              refreshTags();
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Write Failed',
                text: data.error || 'Failed to write value'
              });
            }
          })
          .catch(error => {
            Swal.close();
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Network error occurred'
            });
          });
        }
      });
    }
  });


</script>
{% endblock %}
