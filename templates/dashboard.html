{% extends "base.html" %}
{% set page_title = "Dashboard" %}

{% block content %}
<div class="card border-0 shadow-soft mb-3">
  <div class="card-body d-flex flex-wrap gap-3 align-items-center">
    <div>
      <div class="text-muted small">Device</div>
      <select id="sel-device" class="form-select form-select-sm" onchange="App.changeDevice(this.value)">
        <option value="__all__" {{ 'selected' if current_device=='__all__' else '' }}>All Devices</option>
        {% for dev in devices %}
        <option value="{{ dev.id }}" {{ 'selected' if current_device==dev.id|string else '' }}>
          {{ dev.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="ms-auto small text-muted">Auto refresh: 3s</div>
  </div>
</div>

<div id="device-panels">
  {% if current_device == '__all__' %}
  {% for dev in devices %}
  <div class="card border-0 shadow-soft mb-4">
    <div class="card-header bg-primary text-white rounded-top fw-bold">{{ dev.name }}</div>
    <div class="card-body">
      <div class="row g-4">
        {% for tag in dev.tags %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card border-0 shadow-soft tile">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-semibold">{{ tag.name }}</div>
                  <div class="text-muted small">{{ tag.description or '&nbsp;' }}</div>
                </div>
                <span class="badge bg-secondary">{{ tag.datatype }}</span>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <div>
                  {% if tag.alarm_status == "Normal" %}
                  <span class="badge bg-success">Normal</span>
                  {% else %}
                  <span class="badge bg-danger">Alarm</span>
                  {% endif %}
                </div>
                <div class="small text-muted">
                  <i class="bi bi-clock"></i> {{ tag.ts }}
                </div>
              </div>
              <div class="value-row d-flex align-items-center justify-content-center flex-column">
                <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
                  {{ tag.value if tag.value is not none else '—' }}
                </div>
                <div class="unit">Unit {{ tag.unit }}</div>
              </div>
              <div class="meter mt-2">
                <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:0%"></div>
              </div>
              <div class="text-end small text-muted mt-1" id="tag-ts-{{ tag.id }}"></div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  {% for dev in devices %}
  {% if current_device == dev.id|string %}
  <div class="card border-0 shadow-soft mb-4">
    <div class="card-header bg-primary text-white rounded-top fw-bold">{{ dev.name }}</div>
    <div class="card-body">
      <div class="row g-4">
        {% for tag in dev.tags %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card border-0 shadow-soft tile">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-semibold">{{ tag.name }}</div>
                  <div class="text-muted small">{{ tag.description or '&nbsp;' }}</div>
                </div>
                <span class="badge bg-secondary">{{ tag.datatype }}</span>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <div>
                  {% if tag.alarm_status == "Normal" %}
                  <span class="badge bg-success">Normal</span>
                  {% else %}
                  <span class="badge bg-danger">Alarm</span>
                  {% endif %}
                </div>
                <div class="small text-muted">
                  <i class="bi bi-clock"></i> {{ tag.ts }}
                </div>
              </div>
              <div class="value-row d-flex align-items-center justify-content-center flex-column">
                <div class="value display-6 fw-bold" id="tag-val-{{ tag.id }}">
                  {{ tag.value if tag.value is not none else '—' }}
                </div>
                <div class="unit">Unit {{ tag.unit }}</div>
              </div>
              <div class="meter mt-2">
                <div class="meter-bar bg-info" id="tag-bar-{{ tag.id }}" style="width:0%"></div>
              </div>
              <div class="text-end small text-muted mt-1" id="tag-ts-{{ tag.id }}"></div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}
  {% endif %}


  <div class="ms-auto d-flex gap-2 align-items-center">
    <!-- Nút Add Subdashboard -->
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('subdash_bp.list_subdash') }}">
      + Add Subdashboard
    </a>
    <div class="small text-muted">Auto refresh: 3s</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  window.App = window.App || {};
  App.changeDevice = function (deviceId) {
    window.location.search = '?device=' + deviceId;
  };
  const currentDevice = "{{ current_device }}";
  const apiUrl = `/api/tags?device=${currentDevice}`;
  const socket = io();
  if (window.location.pathname.startsWith('/dashboard')) {
    socket.emit('join', { room: 'dashboard' });
  }


  const tagUpdateTimers = {};
  // Listen for tag updates
  socket.on("update_tags", function (data) {
    if (!data || !data.tags) return;

    data.tags.forEach(tag => {
      const valEl = document.getElementById('tag-val-' + tag.id);
      if (!valEl) return;

      const oldVal = valEl.textContent;
      const newVal = tag.value !== null ? String(tag.value) : '—';

      // update text
      valEl.textContent = newVal;
      const tsEl = document.getElementById('tag-ts-' + tag.id);
      if (tsEl) tsEl.textContent = tag.ts || '';

      // chỉ sáng khi có update mới
      if (oldVal !== newVal) {
        const barEl = document.getElementById('tag-bar-' + tag.id);
        if (barEl) {
          barEl.style.width = "100%";
          barEl.style.backgroundColor = "green";

          if (tagUpdateTimers[tag.id]) clearTimeout(tagUpdateTimers[tag.id]);
          tagUpdateTimers[tag.id] = setTimeout(() => {
            barEl.style.backgroundColor = "";
            barEl.style.width = "0%"; // tắt sau 10s nếu không có update
          }, 20000);
        }
      }
    });
  });


  socket.on('alarm_event', function (data) {
    Swal.fire({
      icon: 'error',
      title: data.title,
      html: `<b>${data.message}</b><br>Status: ${data.status}`,
      background: '#1e1e2d',
      color: '#fff',
      confirmButtonText: 'OK'
    });
  });



  // Initial load
  function refreshTags() {
    fetch("/api/tags?device={{ current_device }}")
      .then(res => res.json())
      .then(data => {
        if (!data.tags) return;
        data.tags.forEach(tag => {
          const valEl = document.getElementById('tag-val-' + tag.id);
          if (valEl) valEl.textContent = tag.value !== null ? tag.value : '—';
          const tsEl = document.getElementById('tag-ts-' + tag.id);
          if (tsEl) tsEl.textContent = tag.ts || '';
        });
      });
  }


</script>
{% endblock %}