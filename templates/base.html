<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or "Modbus Monitor" }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-theme.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/light-theme.css') }}">

</head>

<body class="app-bg">

  <!-- Sidebar (DESKTOP) -->
  <aside id="sidebar" class="app-sidebar d-flex flex-column"><!-- thÃªm id="sidebar", bá» d-none d-md-flex -->
    <div class="px-3 py-4 d-flex align-items-center gap-2 brand">
      <div class="brand-badge">M</div>
      <div class="fw-semibold">Modbus Monitor</div>
    </div>
    <nav class="px-2">
      <!-- Dashboard vá»›i dropdown subdashboards -->
      <div class="nav-item">
        <a class="side-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse"
          href="#dashboardSubmenu" role="button"
          aria-expanded="{{ 'true' if request.path.startswith('/dashboard') or request.path.startswith('/subdash') or request.path == '/' else 'false' }}"
          aria-controls="dashboardSubmenu">
          <span><span class="icon"></span> Dashboard</span>
          <i class="fas fa-chevron-down ms-auto collapse-icon"></i>
        </a>
        <div
          class="collapse {{ 'show' if request.path.startswith('/dashboard') or request.path.startswith('/subdash') or request.path == '/' else '' }}"
          id="dashboardSubmenu">
          <div class="nav flex-column ms-3 mt-1">
            <!-- Debug info -->

            {% if subdashboards %}
            {% for subdash in subdashboards %}
            <div class="d-flex align-items-center">
              <a class="side-link small flex-grow-1 {{ 'active' if request.path.startswith('/subdash/' ~ subdash.id|string) else '' }}"
                href="{{ url_for('subdash_bp.subdash_detail', sid=subdash.id) }}">
                <span class="icon"></span> {{ subdash.name }}
              </a>
              {% if session.get("role") == "admin" %}
              <button type="button" class="btn btn-sm btn-outline-danger ms-2 p-1 delete-subdash-btn"
                data-subdash-id="{{ subdash.id }}" data-subdash-name="{{ subdash.name }}" title="Delete subdashboard"
                style="font-size: 0.7rem; line-height: 1;">
                <i class="fas bi-trash"></i>
              </button>
              {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <span class="side-link small text-muted">No subdashboards available</span>
            {% endif %}
            {% if session.get("role") == "admin" %}
            <hr class="border-secondary my-2">
            <a class="side-link small text-success {{ 'active' if request.path.startswith('/subdash/add') else '' }}"
              href="{{ url_for('subdash_bp.add_subdash') }}">
              <span class="icon">+</span> Add Sub Dashboard
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      <a class="side-link {{ 'active' if request.path.startswith('/alarms') and not request.path.startswith('/settings') else '' }}"
        href="{{ url_for('alarms_bp.alarm_events') }}"><span class="icon"></span> Alarms Logger</a>

      <a class="side-link {{ 'active' if request.path.startswith('/reports') else '' }}"
        href="{{ url_for('reports_bp.reports') }}"><span class="icon"></span> Reports</a>
      {% if session.get("role") == "admin" %}
      <div class="side-section">Settings</div>

      <a class="side-link {{ 'active' if request.path.startswith('/devices') else '' }}"
        href="{{ url_for('devices_bp.devices') }}"><span class="icon"></span> Devices</a>

      <a class="side-link {{ 'active' if request.path.startswith('/alarm-settings') else '' }}"
        href="{{ url_for('alarms_bp.alarm_settings') }}"><span class="icon"></span> Alarm Setting</a>

      <a class="side-link {{ 'active' if request.path.startswith('/data-logger-settings') else '' }}"
        href="{{ url_for('logger_settings_bp.datalogger_settings') }}"><span class="icon"></span> Data Logger
        Setting</a>
      {% endif %}
      <div class="side-section">User Management</div>
      <a class="side-link {{ 'active' if request.path.startswith('/user-management') else '' }}"
        href="{{ url_for('auth_bp.user_management') }}"><span class="icon"></span> User</a>
      <a class="side-link" href="{{ url_for('auth_bp.logout') }}"><span class="icon"></span>Logout</a>
    </nav>
    <div class="mt-auto small text-muted px-3 pb-3">Â©Modbus Monitor 2025</div>
  </aside>

  <!-- Main -->
  <main class="app-main">
    <!-- Topbar -->
    <header class="app-topbar">
      <!-- Chá»‰ cÃ²n 1 nÃºt toggle cho desktop -->
      <button class="btn btn-sm btn-outline-secondary" id="sidebarToggle" aria-label="Toggle sidebar">â˜°</button>
      <div class="page-title ms-2">{{ page_title or 'Dashboard' }}</div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <!-- Notification Bell -->
        <div class="dropdown position-relative">
          <button class="btn btn-sm btn-outline-secondary position-relative" id="notificationBell" type="button"
            data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-bell"></i>
            <!-- Notification Badge -->
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              id="notificationBadge" style="display: none; font-size: 0.6em;">
              0
            </span>
          </button>
          <!-- Dropdown Menu -->
          <div class="dropdown-menu dropdown-menu-end shadow-lg"
            style="width: 320px; max-height: 400px; overflow-y: auto;">
            <div class="dropdown-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Alarm Notifications</h6>
              <button class="btn btn-sm btn-outline-secondary" id="clearAllNotifications" title="Clear All">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div class="dropdown-divider"></div>
            <div id="notificationList">
              <div class="dropdown-item-text text-muted text-center py-3">
                <i class="bi bi-bell-slash"></i><br>
                No active alarms
              </div>
            </div>
          </div>
        </div>
        <!-- NÃºt chuyá»ƒn theme -->
        <button id="themeToggle" class="btn btn-sm btn-outline-secondary" aria-label="Toggle theme">ðŸŒ™</button>
      </div>

    </header>

    <!-- Page -->
    <section class="app-container">
      {% with messages = get_flashed_messages() %}
      {% if messages %}
      <div class="alert alert-info shadow-sm">{{ messages[0] }}</div>
      {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </section>
  </main>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Theme toggle
    (function () {
      const KEY = 'theme';
      const root = document.documentElement;
      const btn = document.getElementById('themeToggle');
      if (!btn) return;

      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const saved = localStorage.getItem(KEY);
      const initTheme = saved || (prefersDark ? 'dark' : 'light');
      root.setAttribute('data-bs-theme', initTheme);

      const setIcon = () => btn.textContent =
        (root.getAttribute('data-bs-theme') === 'dark') ? 'ðŸŒ™' : 'ðŸŒ¤ï¸';
      setIcon();

      btn.addEventListener('click', () => {
        const cur = root.getAttribute('data-bs-theme');
        const next = (cur === 'dark') ? 'light' : 'dark';
        root.setAttribute('data-bs-theme', next);
        localStorage.setItem(KEY, next);
        setIcon();
      });
    })();

    // Desktop sidebar toggle
    (function () {
      const sidebar = document.getElementById('sidebar');        // <-- giá» Ä‘Ã£ cÃ³ id
      const main = document.querySelector('.app-main');
      const btn = document.getElementById('sidebarToggle');
      if (!sidebar || !btn) return;

      btn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        main.classList.toggle('full');
      });
    })();

    // Notification System
    window.NotificationSystem = {
      notifications: [],
      maxNotifications: 10,

      init() {
        this.loadNotifications();
        this.bindEvents();
        this.startPeriodicCheck();
      },

      bindEvents() {
        // Clear all notifications
        document.getElementById('clearAllNotifications')?.addEventListener('click', () => {
          this.clearAll();
        });
      },

      addNotification(notification) {
        // Add timestamp if not provided
        notification.timestamp = notification.timestamp || new Date();
        notification.id = notification.id || Date.now() + Math.random();

        // Add to beginning of array (newest first)
        this.notifications.unshift(notification);

        // Limit number of notifications
        if (this.notifications.length > this.maxNotifications) {
          this.notifications = this.notifications.slice(0, this.maxNotifications);
        }

        this.saveNotifications();
        this.updateUI();
        this.showBellAnimation();
      },

      removeNotification(id) {
        this.notifications = this.notifications.filter(n => n.id !== id);
        this.saveNotifications();
        this.updateUI();
      },

      clearAll() {
        this.notifications = [];
        this.saveNotifications();
        this.updateUI();
      },

      updateUI() {
        const badge = document.getElementById('notificationBadge');
        const list = document.getElementById('notificationList');

        if (!badge || !list) return;

        // Update badge
        if (this.notifications.length > 0) {
          badge.textContent = this.notifications.length;
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }

        // Update list
        if (this.notifications.length === 0) {
          list.innerHTML = `
            <div class="dropdown-item-text text-muted text-center py-3">
              <i class="bi bi-bell-slash"></i><br>
              No active alarms
            </div>
          `;
        } else {
          list.innerHTML = this.notifications.map(n => this.renderNotification(n)).join('');
        }
      },

      renderNotification(notification) {
        const timeStr = this.formatTime(notification.timestamp);
        const levelClass = this.getLevelClass(notification.level);
        const levelIcon = this.getLevelIcon(notification.level);

        return `
          <div class="dropdown-item notification-item" data-id="${notification.id}">
            <div class="d-flex align-items-start gap-2">
              <div class="flex-shrink-0">
                <i class="bi ${levelIcon} text-${levelClass}"></i>
              </div>
              <div class="flex-grow-1 min-width-0">
                <div class="fw-semibold text-truncate">${notification.title || 'Alarm Alert'}</div>
                <div class="small text-muted mb-1">${notification.message || ''}</div>
                <div class="small text-muted">
                  <i class="bi bi-clock"></i> ${timeStr}
                  ${notification.tagName ? `â€¢ <i class="bi bi-tag"></i> ${notification.tagName}` : ''}
                </div>
              </div>
              <button class="btn btn-sm btn-outline-secondary" onclick="NotificationSystem.removeNotification('${notification.id}')" title="Dismiss">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        `;
      },

      getLevelClass(level) {
        const levels = {
          'Critical': 'danger',
          'High': 'warning',
          'Medium': 'info',
          'Low': 'secondary'
        };
        return levels[level] || 'secondary';
      },

      getLevelIcon(level) {
        const icons = {
          'Critical': 'bi-exclamation-triangle-fill',
          'High': 'bi-exclamation-triangle',
          'Medium': 'bi-info-circle',
          'Low': 'bi-info-circle-fill'
        };
        return icons[level] || 'bi-bell';
      },

      formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
      },

      showBellAnimation() {
        const bell = document.querySelector('#notificationBell i');
        if (bell) {
          bell.classList.add('bell-shake');
          setTimeout(() => {
            bell.classList.remove('bell-shake');
          }, 1000);
        }
      },

      saveNotifications() {
        try {
          localStorage.setItem('alarmNotifications', JSON.stringify(this.notifications));
        } catch (e) {
          console.warn('Could not save notifications to localStorage:', e);
        }
      },

      loadNotifications() {
        try {
          const saved = localStorage.getItem('alarmNotifications');
          if (saved) {
            this.notifications = JSON.parse(saved);
            // Convert timestamp strings back to Date objects
            this.notifications.forEach(n => {
              if (typeof n.timestamp === 'string') {
                n.timestamp = new Date(n.timestamp);
              }
            });
          }
        } catch (e) {
          console.warn('Could not load notifications from localStorage:', e);
          this.notifications = [];
        }
        this.updateUI();
      },

      startPeriodicCheck() {
        // Check for new alarms every 30 seconds
        setInterval(() => {
          this.checkForNewAlarms();
        }, 30000);
      },

      async checkForNewAlarms() {
        try {
          const response = await fetch('/api/alarms/recent');
          if (response.ok) {
            const alarms = await response.json();
            alarms.forEach(alarm => {
              // Check if we already have this alarm
              const exists = this.notifications.some(n =>
                n.alarmId === alarm.id ||
                (n.tagId === alarm.tag_id && n.timestamp && new Date(n.timestamp).getTime() === new Date(alarm.created_at).getTime())
              );

              if (!exists) {
                this.addNotification({
                  alarmId: alarm.id,
                  tagId: alarm.tag_id,
                  title: alarm.title || 'Alarm Triggered',
                  message: alarm.message,
                  level: alarm.level,
                  tagName: alarm.tag_name,
                  timestamp: new Date(alarm.created_at)
                });
              }
            });
          }
        } catch (e) {
          console.warn('Could not check for new alarms:', e);
        }
      }
    };

    // Initialize notification system when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      NotificationSystem.init();

      // Listen for real-time alarm events via Socket.IO
      if (typeof socket !== 'undefined') {
        socket.on('alarm_event', function (data) {
          console.log('Received alarm event:', data);

          // Add to notification system
          NotificationSystem.addNotification({
            id: Date.now() + Math.random(), // Generate unique ID
            title: data.title || 'Alarm Alert',
            message: data.message || 'Alarm condition detected',
            level: data.level || 'Critical',
            created_at: new Date().toISOString(),
            status: data.status || 'Active'
          });
        });
      }
    });
  </script>

  <!-- Bell Animation CSS -->
  <style>
    @keyframes bellShake {

      0%,
      100% {
        transform: rotate(0deg);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: rotate(10deg);
      }

      20%,
      40%,
      60%,
      80% {
        transform: rotate(-10deg);
      }
    }

    .bell-shake {
      animation: bellShake 0.8s ease-in-out;
      transform-origin: top center;
    }

    .notification-item:hover {
      background-color: var(--bs-gray-100);
    }

    [data-bs-theme="dark"] .notification-item:hover {
      background-color: var(--bs-gray-800);
    }

    .notification-item {
      cursor: pointer;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--bs-border-color);
    }

    .notification-item:last-child {
      border-bottom: none;
    }
  </style>

  <script>
    // Handle subdashboard deletion
    document.addEventListener('DOMContentLoaded', function () {
      const deleteButtons = document.querySelectorAll('.delete-subdash-btn');

      deleteButtons.forEach(button => {
        button.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation(); // Prevent navigation to subdashboard

          const subdashId = this.dataset.subdashId;
          const subdashName = this.dataset.subdashName;

          if (confirm(`Are you sure you want to delete subdashboard "${subdashName}"?\n\nThis action cannot be undone.`)) {
            // Show loading state
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.disabled = true;

            // Create and submit form for deletion
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/subdash/${subdashId}/delete`;

            document.body.appendChild(form);
            form.submit();
          }
        });
      });
    });
  </script>

  {% block scripts %}{% endblock %}
</body>

</html>