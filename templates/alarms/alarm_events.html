{% extends "base.html" %}
{% set page_title = "Alarm Events" %}
{% block content %}
<div class="card border-0 shadow-soft mb-3">
  <div class="card-body d-flex flex-wrap gap-2 justify-content-between align-items-center">
     <div class="position-relative" style="min-width:280px;max-width:360px;width:100%;">
      <span class="position-absolute top-50 translate-middle-y ms-3 opacity-50">ðŸ”Ž</span>
      <input class="form-control ps-5" placeholder="Search alarmsâ€¦" oninput="App.filterTable('#tbl', this.value)">
    </div>
    <form method="post" action="{{ url_for('alarms_bp.clear_alarm_events_route') }}" onsubmit="return confirm('Clear all alarm events?')">
      <button class="btn btn-danger btn-sm">Clear All</button>
    </form>
  </div>
</div>
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0" id="tbl">
      <thead class="table-dark-subtle">
        <tr>
          <th>Time</th>
          <th>Name</th>
          <th>Level</th>
          <th>Target</th>
          <th>Value</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody>
        {% for e in items %}
        <tr>
          <td>{{ e.ts }}</td>
          <td>{{ e.name }}</td>
          <td><span class="badge text-bg-secondary">{{ e.level }}</span></td>
          <td>{{ e.target }}</td>
          <td>{{ e.value }}</td>
          <td>{{ e.note }}</td>
          <td class="text-end">
            <form method="post" action="{{ url_for('alarms_bp.delete_alarm_event', eid=e.id) }}" style="display:inline;" onsubmit="return confirm('Delete this event?')">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted py-4">No alarm events.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
window.App = window.App || {};
App.filterTable = function(tableSelector, keyword) {
  const table = document.querySelector(tableSelector);
  if (!table) return;
  const rows = table.querySelectorAll('tbody tr');
  const search = keyword.trim().toLowerCase();
  rows.forEach(row => {
    // Combine all cell text in the row
    const text = Array.from(row.cells).map(td => td.textContent.toLowerCase()).join(' ');
    // Show row if search is empty or found in text
    row.style.display = (!search || text.includes(search)) ? '' : 'none';
  });
};
let lastAlarmId = null;
function fetchAlarmEvents() {
  fetch("/alarms/api/alarm-events")
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#tbl tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      if (!data.items || data.items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">No alarm events.</td></tr>`;
        return;
      }
      // Check for new alarm
      if (lastAlarmId !== null && data.items[0].id !== lastAlarmId) {
        alert("New alarm event!");
      }
      lastAlarmId = data.items[0].id;
      data.items.forEach(e => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${e.ts}</td>
          <td>${e.name}</td>
          <td><span class="badge text-bg-secondary">${e.level}</span></td>
          <td>${e.target}</td>
          <td>${e.value}</td>
          <td>${e.note}</td>
          <td class="text-end">
            <form method="post" action="/alarms/events/${e.id}/delete" style="display:inline;" onsubmit="return confirm('Delete this event?')">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </td>
        `;
        tbody.appendChild(row);
      });
    });
}
fetchAlarmEvents();
setInterval(fetchAlarmEvents, 3000);
</script>
{% endblock %}
