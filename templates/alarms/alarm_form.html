{% extends "base.html" %}
{% set page_title = "Add Alarm Logger" %}

{% block content %}

<div class="card border-0 shadow-soft" style="max-width:860px;margin:0 auto;">
  <div class="card-header bg-transparent">
    <h5 class="card-title">{{ 'Edit Alarm' if editing else 'Add Alarm' }}</h5>
  </div>

  <form method="post">
    <div class="card-body">
      <div class="row g-3">

        <!-- Enabled -->
        <div class="col-12">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="enabled" name="enabled" {{ 'checked' if
              (form.get('enabled', True) if form else True) else '' }}>
            <label class="form-check-label" for="enabled">Actived</label>
          </div>
        </div>

        <!-- Target -->
        <div class="col-md-6">
          <label class="form-label">Target Tag *</label>
          <select name="target" class="form-select" required>
            <option value="">-- Select Tag --</option>
            {% for t in tags %}
            {% set val = t.id %}
            {% set selected = 'selected' if (form.get('target')|string == val|string) else '' %}
            <option value="{{ val }}" {{ selected }}>
              {{ t.device_name }} — {{ t.tag_name }} ({{ t.address }}, {{ t.datatype }})
            </option>
            {% endfor %}
          </select>
          <div class="form-text">Hiển thị: Device — Tag (Address, Datatype)</div>
        </div>



        <!-- Alarm Code -->
        <div class="col-12">
          <label class="form-label">Alarm Code *</label>
          <input name="code" class="form-control" value="{{ form.get('code', '') if form else '' }}">
        </div>

        <!-- Display Name -->
        <div class="col-12">
          <label class="form-label">Display Name *</label>
          <input name="name" class="form-control" placeholder="Display Name"
            value="{{ form.get('name', '') if form else '' }}" required>
        </div>

        <!-- Level -->
        <div class="col-md-6">
          <label class="form-label">Level *</label>
          <select name="level" class="form-select" required>
            {% set selected_level = form.get('level', 'High') if form else 'High' %}
            <option {{ 'selected' if selected_level=='Low' else '' }}>Low</option>
            <option {{ 'selected' if selected_level=='Medium' else '' }}>Medium</option>
            <option {{ 'selected' if selected_level=='High' else '' }}>High</option>
            <option {{ 'selected' if selected_level=='Critical' else '' }}>Critical</option>
          </select>
        </div>

        <!-- Operator -->
        <div class="col-md-6">
          <label class="form-label">Operator *</label>
          {% set op = (form.get('operator') or '') %}
          <select name="operator" class="form-select" required>
            <option value="== " {{ 'selected' if op=='==' else '' }}>Equal</option>
            <option value="!=" {{ 'selected' if op=='!=' else '' }}>Not Equal</option>
            <option value=">" {{ 'selected' if op=='>' else '' }}>Greater Than</option>
            <option value=">=" {{ 'selected' if op=='>=' else '' }}>Greater Or Equal</option>
            <option value="<" {{ 'selected' if op=='<' else '' }}>Less Than</option>
            <option value="<=" {{ 'selected' if op=='<=' else '' }}>Less Or Equal</option>
          </select>

        </div>

        <!-- Compare Value -->
        <div class="col-12">
          <label class="form-label">Compare Value *</label>
          <input name="threshold" class="form-control" placeholder="Compare Value" required>
          <div class="form-text">Nếu chọn “In Range / Not In Range” hãy nhập dạng <code>min,max</code>.</div>
        </div>

        <!-- Stable times -->
        <div class="col-md-6">
          <label class="form-label">On Stable Time (seconds) *</label>
          <input type="number" min="0" step="1" name="on_stable" class="form-control"
            value="{{ form.get('on_stable_sec', 10) if form else 10 }}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Off Stable Time (seconds) *</label>
          <input type="number" min="0" step="1" name="off_stable" class="form-control"
            value="{{ form.get('off_stable_sec', 30) if form else 30 }}" required>
        </div>

        <!-- Send to -->
        <div class="col-12">
          <label class="form-label">Send To Email</label>
          <textarea name="email" class="form-control" rows="2"
            placeholder="example1@gmail.com, example2@gmail.com, ...">{{ form.get('email', '') if form else '' }}</textarea>
        </div>
        <div class="col-12">
          <label class="form-label">Send To SMS</label>
          <textarea name="sms" class="form-control" rows="2"
            placeholder="+84xxxxxxxxx, +84xxxxxxxxx, ...">{{ form.get('sms', '') if form else '' }}</textarea>
        </div>

        <!-- Description -->
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3" placeholder="Description">{{ form.get('description', '') if form else '' }}</textarea>
        </div>

      </div>
    </div>

    <div class="card-footer d-flex justify-content-end gap-2">
      <a class="btn btn-secondary" href="{{ url_for('alarms_bp.alarm_settings') }}">Cancel</a>
      <button class="btn btn-primary">Submit</button>
    </div>
  </form>
</div>
{% endblock %}